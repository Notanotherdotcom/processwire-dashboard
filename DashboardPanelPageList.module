<?php namespace ProcessWire;

class DashboardPanelPageList extends DashboardPanel {

    public static function getModuleInfo() {
        return array_merge(parent::getModuleInfo(),
            [
                'title'    => __('Dashboard Panel: PageList', __FILE__),
                'summary'  => __('Display a ProcessPageList widget for any parent', __FILE__),
                'author'   => 'Philipp Daun',
                'version'  => DASHBOARD_VERSION,
            ]
        );
    }

    public function getContent() {
        // Generate page list
        $module = $this->modules->get('ProcessPageList');
        $module->set('id', $this->parentID);
        $module->set('showRootPage', $this->showRootPage);
        $output = $module->execute();

        // Modify markup
        $unique_key = rand(1, 99999);
        $container_id = "PageListContainer__{$unique_key}";
        $output = str_replace("id='PageListContainer'", "id='{$container_id}'", $output);
        $output = preg_replace('/<script>.*?<\/script>/', '', $output);
        $output .= "<script>$('#{$container_id}').ProcessPageList(ProcessWire.config.ProcessPageList);</script>";

        return $output;
    }

    public function setup() {
        parent::setup();
        $this->parent = $this->getPageFromObjectOrSelectorOrID($this->data['parent'] ?? null);
        $this->parentID = $this->parent ? $this->parent->id : null;
        $this->showRootPage = $this->data['showRootPage'] ?? true;
    }
}
